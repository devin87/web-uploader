//devin87@qq.com
//build:2014/09/19 15:37:16
(function(u,m){function v(a,b){var c=a.lastIndexOf(b);return-1!=c?a.slice(c):""}function w(a){if(a){a=a.split(",");for(var b={},c=0,d=a.length;c<d;c++)b[a[c]]=!0;return b}}function B(a,b){a.attachEvent?a.attachEvent("onload",b):a.addEventListener("load",b,!1)}function l(a){this.guid=a.guid||"uploader"+ ++C;this.url=a.url;this.dataType=a.dataType||"json";this.data=a.data;this.target=a.target;this.html5=n&&!!x(a.html5,!0);this.multiple=r&&this.html5&&!!x(a.multiple,!0);this.workerIdle=this.workerThread=
this.html5?a.workerThread||1:1;this.auto=!1!==a.auto;this.upName=a.upName||"upfile";this.allows=w(a.allows);this.disallows=w(a.disallows);this.container=a.container||document.body;a.getPos&&(this.getPos=a.getPos);var b=a.UI||{};b.init&&(this.init=b.init);b.draw&&(this.draw=b.draw);b.update&&(this.update=b.update);b.over&&(this.over=b.over);this.fns=a.on||{};this.ops=a;this.list=[];this.map={};this.index=0;this.started=!1;this._init()}var x=Q.def,p=Q.fire,y=Q.extend,z=Q.getFirst,D=Q.getLast,E=JSON.parse,
A=Q.createEle,F=Q.parseHTML,G=Q.setOpacity,H=Q.getOffset,s=Q.Event,t=s.add,I=s.fire,J=s.stop,n=!1,r=!1,q=!1,C=0,K=0,L=0;l.prototype={constructor:l,_init:function(){var a=this;if(!a._inited){a._inited=!0;var b=a.guid,c=a.target,d=a.container,e=A("div","upload-input "+b);d.appendChild(e);a.boxInput=e;q?t(c,"click",function(b){!1!==a.fire("select",b)&&(a.resetInput(),I(a.inputFile,"click"))}):(t(e,"click",function(b){!1===a.fire("select",b)&&J(b)}),G(e,0));if(!a.html5){c="upload_iframe_"+b;b=A("div",
"upload-html4 "+b,'<iframe class="u-iframe" name="'+c+'"></iframe><form class="u-form" action="" method="post" enctype="multipart/form-data" target="'+c+'"></form>');d.appendChild(b);var g=z(b),d=D(b);a.iframe=g;a.form=d;B(g,function(){if(0==a.workerIdle){var b;try{b=g.contentWindow.document.body.innerHTML}catch(c){}a.complete(m,2,b)}});a.resetInput()}a.fire("init");return a.run("init")}},resetInput:function(){var a=this,b=a.boxInput,c=a.target,d=c.offsetWidth,c=c.offsetHeight;b.innerHTML='<input type="file" name="'+
a.upName+'" style="'+(q?"visibility: hidden;":"width:"+d+"px;height:"+c+"px;font-size:100px;")+'"'+(a.multiple?' multiple="multiple"':"")+">";b.style.width=d+"px";b.style.height=c+"px";b=z(b);t(b,"change",function(b){if((b=b.target)&&b.files){b=b.files;for(var c=b.length,d=0;d<c;d++)a.add(this,b[d])}else a.add(this);a.html5||a.resetInput()});a.inputFile=b;a.updatePos();return a},updatePos:function(a){if(!q){var b=this.getPos||H,c=this.boxInput,d=this.target,b=0==d.offsetWidth?{left:-1E4,top:-1E4}:
b(d);c.style.left=b.left+"px";c.style.top=b.top+"px";a&&(c.style.zIndex=++L)}},fire:function(a,b,c){if(!c)return p(this.fns[a],this,b);var d=this.fns[a+"Async"];if(d)return p(d,this,b,c);c(p(this.fns[a],this,b))},run:function(a,b){var c=this[a];c&&p(c,this,b);return this},add:function(a,b){var c=this,d=b?b.name||b.fileName:v(a.value,"\\").slice(1)||a.value,e=v(d,".").toLowerCase(),g=b?b.size||f.fileSize:-1,h=c.disallows&&c.disallows[e]||c.allows&&!c.allows[e],k={id:++K,name:d,ext:e,size:g,input:a,
file:b,state:h?-1:0};h&&(k.disabled=!0);c.fire("add",k,function(a){!1===a||k.disabled||(k.index=c.list.length,c.list.push(k),c.map[k.id]=k,c.run("draw",k),c.auto&&c.start())});return c},get:function(a){if(a!=m)return this.map[a]},cancel:function(a){if(a=this.get(a)){var b=a.state;if(0!=b&&1!=b)return this;if(1==b){if(b=a.xhr)return b.abort(),this;this.iframe.contentWindow.location="about:blank"}return this.complete(a,-2)}},remove:function(a){var b=this.get(a);b&&(1==b.state&&this.cancel(a),b.deleted=
!0,this.fire("remove",b))},start:function(){var a=this.workerIdle,b=this.list,c=this.index,d=b.length;this.started||(this.started=!0);if(0>=d||c>=d||0>=a)return this;a=b[c];this.index++;return this.upload(a)},upload:function(a){var b=this;if(!a||0!=a.state)return b.start();a.url=b.url;b.workerIdle--;b.fire("upload",a,function(c){if(!1===c)return b.complete(a,-1);b.html5&&a.file?b._upload_html5(a):b._upload_html4(a)});return b},_process_params:function(a,b){this.data&&Object.forEach(this.data,b);a.data&&
Object.forEach(a.data,b)},_upload_html5:function(a){var b=this,c=new XMLHttpRequest;a.xhr=c;c.upload.addEventListener("progress",function(c){b.progress(a,c.total,c.loaded)},!1);c.addEventListener("load",function(c){b.complete(a,2,c.target.responseText)},!1);c.addEventListener("error",function(){b.complete(a,-3)},!1);c.addEventListener("abort",function(){b.complete(a,-2)},!1);var d=new FormData;d.append(b.upName,a.file);b._process_params(a,function(a,b){d.append(a,b)});c.open("POST",a.url);c.setRequestHeader("X-Requested-With",
"XMLHttpRequest");b.fire("send",a,function(e){if(!1===e)return b.complete(a,-1);c.send(d);b._afterSend(a)})},_upload_html4:function(a){var b=this,c=b.form;a.input.name=b.upName;c.innerHTML="";c.appendChild(a.input);c.action=a.url;b._process_params(a,function(a,b){c.appendChild(F('<input type="hidden" name="'+a+'" value="'+b+'">'))});b.fire("send",a,function(d){if(!1===d)return b.complete(a,-1);c.submit();b._afterSend(a)})},_afterSend:function(a){a.time=a.timeStart=Date.now();a.state=1;this._lastTask=
a;this.progress(a)},progress:function(a,b,c){b||(b=a.size);if(!c||0>c)c=0;var d=a.state||0;c>b&&(c=b);0<c&&0==d&&(a.state=d=1);2==d&&(b=c=a.size);var d=b,e=c;if(d&&!(0>=d)){var g=Date.now(),h;if(e>=d){if(h=g-a.timeStart)a.avg_speed=Math.min(Math.round(1E3*d/h),d);a.timeEnd=g}else h=g-a.time,200>h||(a.speed=Math.min(Math.round(1E3*(e-a.loaded)/h),a.total),a.time=g)}a.total=b;a.loaded=c;this.fire("progress",a);this.run("update",a)},_process_response:function(a,b){(a.response=b)&&"json"==this.dataType&&
(a.json=E(b))},complete:function(a,b,c){a||1!=this.workerThread||(a=this._lastTask);a&&(b!=m&&(a.state=b),1==a.state&&(a.state=2,this.progress(a,a.size,a.size)),c!==m&&this._process_response(a,c));-2==b&&this.fire("cancel",a);this.fire("complete",a);this.run("over",a).run("update",a);this.workerIdle++;this.started&&this.start();return this}};l.extend=function(a,b){y(l.prototype,a,b)};(function(){var a=u.XMLHttpRequest;a&&(new a).upload&&u.FormData&&(n=!0);a=document.createElement("input");a.type=
"file";r=!!a.files;q=n})();y(l,{support:{html5:n,multiple:r},READY:0,PROCESSING:1,COMPLETE:2,SKIP:-1,CANCEL:-2,ERROR:-3,getStatusText:function(a){switch(a){case 0:return"\u51c6\u5907\u4e2d";case 1:return"\u4e0a\u4f20\u4e2d";case 2:return"\u5df2\u5b8c\u6210";case -1:return"\u5df2\u8df3\u8fc7";case -2:return"\u5df2\u53d6\u6d88";case -3:return"\u5df2\u5931\u8d25"}return a}});Q.Uploader=l})(window);
